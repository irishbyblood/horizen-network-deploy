<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Dashboard - Horizen Network</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .welcome-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .welcome-banner h1 {
            margin: 0 0 10px 0;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .status-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-card h3 {
            margin-top: 0;
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        
        .status-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.trial {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-badge.canceled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .section h2 {
            margin-top: 0;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .service-card {
            border: 2px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .service-card:hover {
            border-color: #4CAF50;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .service-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .service-card h3 {
            margin: 10px 0;
        }
        
        .service-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .lock-icon {
            display: inline-block;
            margin-left: 5px;
        }
        
        .payment-history {
            margin-top: 20px;
        }
        
        .payment-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .payment-table th,
        .payment-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .payment-table th {
            background: #f5f5f5;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner-large {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1><a href="/" style="color: inherit; text-decoration: none;">üåê Horizen Network</a></h1>
            </div>
            <nav>
                <a href="/">Home</a>
                <a href="/subscription/pricing.html">Pricing</a>
                <a href="/subscription/index.html">Dashboard</a>
            </nav>
        </header>

        <div class="dashboard-container">
            <div id="loading-state" class="loading">
                <div class="spinner-large"></div>
                <p>Loading your subscription...</p>
            </div>
            
            <div id="content" style="display: none;">
                <div class="welcome-banner">
                    <h1>Welcome to Horizen Network</h1>
                    <p id="welcome-message">Manage your subscription and access your services</p>
                </div>

                <!-- Subscription Status -->
                <div class="status-grid">
                    <div class="status-card">
                        <h3>Current Plan</h3>
                        <div class="status-value" id="plan-name">‚Äî</div>
                        <span class="status-badge" id="plan-status">Loading</span>
                    </div>
                    
                    <div class="status-card">
                        <h3>Billing Amount</h3>
                        <div class="status-value" id="billing-amount">$0.00</div>
                        <p style="color: #666; font-size: 0.9em;">per month</p>
                    </div>
                    
                    <div class="status-card">
                        <h3>Next Billing Date</h3>
                        <div class="status-value" id="next-billing" style="font-size: 1.3em;">‚Äî</div>
                        <div id="billing-actions" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="section">
                    <h2>Quick Actions</h2>
                    <div class="action-buttons">
                        <a href="/subscription/manage.html" class="btn btn-primary">Manage Subscription</a>
                        <a href="/subscription/pricing.html" class="btn btn-secondary">View Plans</a>
                        <button id="portal-btn" class="btn btn-secondary">Billing Portal</button>
                    </div>
                </div>

                <!-- Access Your Services -->
                <div class="section">
                    <h2>Your Services</h2>
                    <div class="service-grid" id="services-grid">
                        <!-- Services will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Payment History -->
                <div class="section">
                    <h2>Payment History</h2>
                    <div class="payment-history">
                        <table class="payment-table" id="payment-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="payment-tbody">
                                <tr>
                                    <td colspan="4" style="text-align: center;">Loading payment history...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- No Subscription State -->
            <div id="no-subscription" style="display: none;">
                <div class="section" style="text-align: center; padding: 60px 30px;">
                    <h2>No Active Subscription</h2>
                    <p style="color: #666; margin: 20px 0;">You don't have an active subscription yet.</p>
                    <a href="/subscription/pricing.html" class="btn btn-primary">View Plans</a>
                </div>
            </div>
        </div>

        <footer>
            <div class="footer-content">
                <p>&copy; 2024 Horizen Network. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // Mock user ID - in production, get from session/auth
        const userId = 1; // Replace with actual user ID from authentication
        
        // Service configurations
        const services = {
            'druid': {
                name: 'Apache Druid',
                icon: 'üìä',
                url: '/druid',
                plans: ['druid_geniess']
            },
            'geniess': {
                name: 'Geniess Intelligence',
                icon: 'üîÆ',
                url: 'http://geniess.horizen-network.com',
                plans: ['druid_geniess']
            },
            'entity': {
                name: 'Entity AI',
                icon: 'ü§ñ',
                url: '/entity',
                plans: ['entity', 'druid_geniess']
            }
        };
        
        // Load subscription data
        async function loadSubscription() {
            try {
                // Fetch subscription status from API
                const response = await fetch(`/api/payment/subscription/${userId}`);
                const data = await response.json();
                
                if (data.has_access) {
                    displaySubscription(data);
                } else {
                    displayNoSubscription();
                }
            } catch (error) {
                console.error('Error loading subscription:', error);
                // Show mock data for demo purposes
                displayMockSubscription();
            }
        }
        
        function displaySubscription(data) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            
            // Update plan info
            const planNames = {
                'entity': 'Entity AI',
                'druid_geniess': 'Druid + Geniess Bundle'
            };
            
            const planPrices = {
                'entity': '$5.00',
                'druid_geniess': '$15.00'
            };
            
            document.getElementById('plan-name').textContent = planNames[data.plan_type] || 'Unknown';
            document.getElementById('billing-amount').textContent = planPrices[data.plan_type] || '$0.00';
            
            // Update status badge
            const statusBadge = document.getElementById('plan-status');
            statusBadge.textContent = data.status === 'trialing' ? 'Free Trial' : 'Active';
            statusBadge.className = `status-badge ${data.status}`;
            
            // Update billing date
            if (data.period_end) {
                const date = new Date(data.period_end);
                document.getElementById('next-billing').textContent = date.toLocaleDateString();
                
                if (data.cancel_at_period_end) {
                    document.getElementById('billing-actions').innerHTML = 
                        '<p style="color: #f44336; font-size: 0.9em;">‚ö†Ô∏è Cancels on this date</p>';
                }
            }
            
            // Populate services
            populateServices(data.plan_type);
            
            // Load payment history
            loadPaymentHistory();
        }
        
        function displayNoSubscription() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('no-subscription').style.display = 'block';
        }
        
        function displayMockSubscription() {
            // Mock data for demonstration
            displaySubscription({
                has_access: true,
                plan_type: 'druid_geniess',
                status: 'active',
                period_end: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                cancel_at_period_end: false
            });
        }
        
        function populateServices(planType) {
            const servicesGrid = document.getElementById('services-grid');
            servicesGrid.innerHTML = '';
            
            for (const [key, service] of Object.entries(services)) {
                const hasAccess = service.plans.includes(planType);
                const card = document.createElement('div');
                card.className = `service-card ${hasAccess ? '' : 'locked'}`;
                
                card.innerHTML = `
                    <div class="service-icon">${service.icon}</div>
                    <h3>${service.name} ${hasAccess ? '' : '<span class="lock-icon">üîí</span>'}</h3>
                    ${hasAccess ? 
                        `<a href="${service.url}" class="btn btn-primary" style="margin-top: 10px;">Launch</a>` :
                        `<p style="color: #666; font-size: 0.9em;">Upgrade to access</p>`
                    }
                `;
                
                servicesGrid.appendChild(card);
            }
        }
        
        async function loadPaymentHistory() {
            try {
                const response = await fetch(`/api/payment/history/${userId}`);
                const payments = await response.json();
                
                const tbody = document.getElementById('payment-tbody');
                
                if (payments && payments.length > 0) {
                    tbody.innerHTML = payments.map(payment => `
                        <tr>
                            <td>${new Date(payment.created_at).toLocaleDateString()}</td>
                            <td>${payment.plan_type === 'druid_geniess' ? 'Druid + Geniess' : 'Entity AI'}</td>
                            <td>$${(payment.amount / 100).toFixed(2)}</td>
                            <td><span class="status-badge ${payment.status}">${payment.status}</span></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No payment history yet</td></tr>';
                }
            } catch (error) {
                console.error('Error loading payment history:', error);
                document.getElementById('payment-tbody').innerHTML = 
                    '<tr><td colspan="4" style="text-align: center;">Unable to load payment history</td></tr>';
            }
        }
        
        // Handle billing portal button
        document.getElementById('portal-btn').addEventListener('click', async function() {
            try {
                const response = await fetch(`/api/payment/billing-portal/${userId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.url) {
                    window.location.href = data.url;
                }
            } catch (error) {
                alert('Unable to open billing portal. Please try again.');
            }
        });
        
        // Check for success parameter (after signup)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('success') === 'true') {
            alert('üéâ Congratulations! Your subscription is now active. Welcome to Horizen Network!');
            // Remove success parameter from URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        // Load subscription on page load
        loadSubscription();
    </script>
</body>
</html>
