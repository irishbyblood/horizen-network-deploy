name: Scheduled Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  backup-production:
    permissions:
      contents: read
    name: Backup Production Data
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Backup Script with Retry
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.PRODUCTION_USERNAME }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
              cd /opt/horizen-network-deploy
              ./scripts/backup.sh
            EOF
          on_retry_command: |
            echo "Backup attempt failed, retrying in 60 seconds..."

      - name: Upload Backup to S3
        uses: appleboy/ssh-action@master
        if: success()
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            # Install AWS CLI if not present
            if ! command -v aws &> /dev/null; then
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip awscliv2.zip
              sudo ./aws/install
            fi
            
            # Configure AWS credentials
            export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            export AWS_DEFAULT_REGION=${{ secrets.AWS_REGION }}
            
            # Upload latest backups to S3
            cd /opt/horizen-network-deploy
            LATEST_BACKUP=$(ls -t backups/*.tar.gz | head -1)
            aws s3 cp "$LATEST_BACKUP" s3://${{ secrets.BACKUP_BUCKET }}/horizen-network/

      - name: Verify Backup Size and Integrity
        uses: appleboy/ssh-action@master
        if: success()
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/horizen-network-deploy/backups
            
            # Find latest backup files
            LATEST_POSTGRES=$(ls -t postgres_*.sql.gz 2>/dev/null | head -1)
            LATEST_MONGO=$(ls -t mongodb_*.tar.gz 2>/dev/null | head -1)
            LATEST_CONFIG=$(ls -t config_*.tar.gz 2>/dev/null | head -1)
            
            ERRORS=0
            
            # Verify PostgreSQL backup
            if [ -f "$LATEST_POSTGRES" ]; then
              SIZE=$(stat -c%s "$LATEST_POSTGRES" 2>/dev/null || stat -f%z "$LATEST_POSTGRES")
              if [ "$SIZE" -gt 10000 ]; then
                echo "✓ PostgreSQL backup verified: $LATEST_POSTGRES ($(numfmt --to=iec $SIZE))"
                # Test gunzip
                if gunzip -t "$LATEST_POSTGRES" 2>/dev/null; then
                  echo "✓ PostgreSQL backup compression is valid"
                else
                  echo "✗ PostgreSQL backup compression is corrupted"
                  ((ERRORS++))
                fi
              else
                echo "✗ PostgreSQL backup too small: $SIZE bytes"
                ((ERRORS++))
              fi
            else
              echo "✗ No PostgreSQL backup found"
              ((ERRORS++))
            fi
            
            # Verify MongoDB backup
            if [ -f "$LATEST_MONGO" ]; then
              SIZE=$(stat -c%s "$LATEST_MONGO" 2>/dev/null || stat -f%z "$LATEST_MONGO")
              if [ "$SIZE" -gt 10000 ]; then
                echo "✓ MongoDB backup verified: $LATEST_MONGO ($(numfmt --to=iec $SIZE))"
                # Test tar
                if tar -tzf "$LATEST_MONGO" > /dev/null 2>&1; then
                  echo "✓ MongoDB backup archive is valid"
                else
                  echo "✗ MongoDB backup archive is corrupted"
                  ((ERRORS++))
                fi
              else
                echo "✗ MongoDB backup too small: $SIZE bytes"
                ((ERRORS++))
              fi
            else
              echo "⚠ No MongoDB backup found"
            fi
            
            # Verify config backup
            if [ -f "$LATEST_CONFIG" ]; then
              SIZE=$(stat -c%s "$LATEST_CONFIG" 2>/dev/null || stat -f%z "$LATEST_CONFIG")
              echo "✓ Config backup verified: $LATEST_CONFIG ($(numfmt --to=iec $SIZE))"
            fi
            
            if [ $ERRORS -gt 0 ]; then
              echo "Backup verification failed with $ERRORS error(s)"
              exit 1
            fi
            
            echo "All backups verified successfully"

      - name: Send Success Notification
        if: success()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/horizen-network-deploy
            BACKUP_SIZE=$(du -sh backups/ | cut -f1)
            ./scripts/notify.sh "backup_success" "Production backup completed successfully" "Backup size: $BACKUP_SIZE" || true

      - name: Send Slack Notification (Success)
        if: success() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "✅ Horizen Network Backup Successful",
              "attachments": [
                {
                  "color": "good",
                  "fields": [
                    {"title": "Environment", "value": "Production", "short": true},
                    {"title": "Status", "value": "Success", "short": true},
                    {"title": "Workflow", "value": "${{ github.workflow }}", "short": true},
                    {"title": "Time", "value": "${{ github.event.head_commit.timestamp }}", "short": true}
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Send Failure Notification
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/horizen-network-deploy
            ./scripts/notify.sh "backup_failed" "Production backup failed" "Check logs for details" || true

      - name: Send Slack Notification (Failure)
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "❌ Horizen Network Backup Failed",
              "attachments": [
                {
                  "color": "danger",
                  "fields": [
                    {"title": "Environment", "value": "Production", "short": true},
                    {"title": "Status", "value": "Failed", "short": true},
                    {"title": "Workflow", "value": "${{ github.workflow }}", "short": true},
                    {"title": "Run URL", "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "short": false}
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  backup-staging:
    name: Backup Staging Data
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Backup Script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/horizen-network-deploy
            ./scripts/backup.sh

      - name: Cleanup Old Backups
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/horizen-network-deploy/backups
            # Keep only last 7 days of backups in staging
            find . -name "*.tar.gz" -mtime +7 -delete
            find . -name "*.sql.gz" -mtime +7 -delete
