name: Scheduled Backup

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  backup-production:
    permissions:
      contents: read
    name: Backup Production Data
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Backup Script (with retry)
        id: backup
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USERNAME }}@${{ secrets.PRODUCTION_HOST }} '
              cd /opt/horizen-network-deploy
              ./scripts/backup.sh
            '

      - name: Upload Backup to S3 (with retry)
        id: s3_upload
        uses: nick-fields/retry@v2
        if: success()
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_USERNAME }}@${{ secrets.PRODUCTION_HOST }} '
              # Install AWS CLI if not present
              if ! command -v aws &> /dev/null; then
                curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                unzip -q awscliv2.zip
                sudo ./aws/install
                rm -rf awscliv2.zip aws
              fi
              
              # Configure AWS credentials
              export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
              export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
              export AWS_DEFAULT_REGION=${{ secrets.AWS_REGION }}
              
              # Upload latest backups to S3
              cd /opt/horizen-network-deploy
              LATEST_BACKUP=$(ls -t backups/*.tar.gz 2>/dev/null | head -1)
              
              if [ -n "$LATEST_BACKUP" ]; then
                echo "Uploading $LATEST_BACKUP to S3..."
                aws s3 cp "$LATEST_BACKUP" "s3://${{ secrets.BACKUP_BUCKET }}/horizen-network/" --no-progress
                echo "Upload completed"
              else
                echo "No backup file found"
                exit 1
              fi
            '

      - name: Verify Backup Integrity
        uses: appleboy/ssh-action@master
        if: success()
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/horizen-network-deploy/backups
            LATEST_BACKUP=$(ls -t *.tar.gz 2>/dev/null | head -1)
            
            if [ -f "$LATEST_BACKUP" ]; then
              # Check file size
              SIZE=$(stat -c%s "$LATEST_BACKUP" 2>/dev/null || stat -f%z "$LATEST_BACKUP" 2>/dev/null)
              if [ "$SIZE" -gt 1000 ]; then
                echo "✓ Backup file size OK: $(($SIZE / 1024 / 1024)) MB"
              else
                echo "✗ Backup file too small: $SIZE bytes"
                exit 1
              fi
              
              # Test archive integrity
              if tar -tzf "$LATEST_BACKUP" >/dev/null 2>&1; then
                echo "✓ Backup archive integrity verified"
              else
                echo "✗ Backup archive is corrupted"
                exit 1
              fi
              
              echo "Backup verified: $LATEST_BACKUP"
            else
              echo "No backup file found"
              exit 1
            fi

      - name: Verify S3 Upload
        if: success()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            export AWS_DEFAULT_REGION=${{ secrets.AWS_REGION }}
            
            # List recent backups in S3
            echo "Recent backups in S3:"
            aws s3 ls "s3://${{ secrets.BACKUP_BUCKET }}/horizen-network/" --recursive | tail -5

      - name: Cleanup Old Backups
        if: success()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/horizen-network-deploy/backups
            # Keep last 30 days locally
            find . -name "*.tar.gz" -mtime +30 -delete
            find . -name "*.sql.gz" -mtime +30 -delete
            echo "Old backups cleaned up"

      - name: Notify Success
        if: success()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/horizen-network-deploy
            if [ -f ./scripts/notify.sh ]; then
              LATEST_BACKUP=$(ls -t backups/*.tar.gz 2>/dev/null | head -1 | xargs basename)
              BACKUP_SIZE=$(stat -c%s "backups/$LATEST_BACKUP" 2>/dev/null | awk '{print int($1/1024/1024)"MB"}' || echo "unknown")
              ./scripts/notify.sh \
                -m "Production backup completed successfully. File: $LATEST_BACKUP (Size: $BACKUP_SIZE)" \
                -t "Backup Success" \
                -s success \
                --all || echo "Notification failed but backup succeeded"
            fi

      - name: Notify Failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/horizen-network-deploy
            if [ -f ./scripts/notify.sh ]; then
              ./scripts/notify.sh \
                -m "Production backup failed. Please investigate immediately." \
                -t "Backup Failed" \
                -s error \
                --all || echo "Notification failed"
            fi

  backup-staging:
    name: Backup Staging Data
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Backup Script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/horizen-network-deploy
            ./scripts/backup.sh

      - name: Cleanup Old Backups
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/horizen-network-deploy/backups
            # Keep only last 7 days of backups in staging
            find . -name "*.tar.gz" -mtime +7 -delete
            find . -name "*.sql.gz" -mtime +7 -delete
